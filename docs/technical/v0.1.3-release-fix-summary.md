# v0.1.3 发布包修复总结

## 修复日期
2026-02-27

## 问题描述
v0.1.2 发布包在其他 Mac 环境下运行失败，出现 multiprocessing 错误。

## 根本原因
1. **uvicorn reload 模式问题**: `reload=True` 在发布包环境下启动子进程监控文件变化，导致 multiprocessing 失败
2. **配置文件泄露**: 打包时包含了开发环境的 `.env` 文件，包含绝对路径
3. **启动脚本路径问题**: `start.sh` 的路径处理不够健壮
4. **缺少配置初始化**: 没有自动从 `.env.example` 创建 `.env`

## 实施的修复

### 1. backend/run.py
添加环境变量控制 reload 模式：
```python
is_dev = os.getenv("ENV", "production") == "development"
uvicorn.run(..., reload=is_dev)
```

### 2. start.sh
改进启动脚本：
- 添加脚本目录检测
- 进入 backend 目录执行操作
- 自动从 `.env.example` 创建 `.env`
- 设置 `ENV=production` 环境变量

### 3. backend/.env.example
修正配置示例：
- 版本号更新为 0.1.3
- `DEBUG=false`（生产环境默认值）
- 添加更多 CORS 源

### 4. scripts/build-release.sh（新增）
创建规范的打包脚本：
- 自动排除开发文件（.env, venv, node_modules, .git 等）
- 排除临时文件（.playwright-mcp, .figma, release 等）
- 生成 SHA256 校验和
- 提供测试和发布指引

## 测试结果

### 打包测试
- ✅ 发布包大小: 17M（从 51M 优化）
- ✅ 不包含 .env 文件
- ✅ 包含 .env.example 文件
- ✅ 不包含开发目录（venv, node_modules, .git）
- ✅ SHA256: 31f90e28751c04b036f18324dcf461de3b2d3e4bad15ae5b8e97df1d0d0f6d9f

### 启动测试
在 `/tmp` 干净环境测试：
- ✅ 解压成功
- ✅ 虚拟环境自动创建
- ✅ 依赖自动安装
- ✅ .env 文件自动从 .env.example 创建
- ✅ 服务启动成功（生产模式，reload=False）
- ✅ 环境变量 ENV=production 正确设置

## 文件变更清单
1. `backend/run.py` - 修改
2. `start.sh` - 修改
3. `backend/.env.example` - 修改
4. `scripts/build-release.sh` - 新增
5. `docs/release-notes/v0.1.3.md` - 新增
6. `docs/guides/release-testing.md` - 新增

## 后续步骤
1. ✅ 创建发布包
2. ✅ 本地测试通过
3. ⏳ 在其他 Mac 环境测试
4. ⏳ 提交代码并打标签
5. ⏳ 发布到 GitHub Releases

## 经验教训
1. **环境隔离**: 开发环境和生产环境应该有明确的区分
2. **配置管理**: 敏感配置不应该打包进发布包
3. **自动化测试**: 应该在干净环境测试发布包
4. **文档完善**: 需要详细的安装和测试文档
